<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.10240 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 14pt;
    }
  </style>
</head>
<body>
<a name="2745"/>

<div>
<span><div><span><font style="font-size: 18pt; color: rgb(186, 0, 255);">定义</font></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;"><font style="font-size: 14pt;">锁是计算机协调多个进程或线程并发访问某一资源的机制。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><span style="font-family: 'Lucida Grande'; line-height: 1.45; text-indent: 0mm;"><font style="font-size: 14pt;">在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</font></span></div></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">锁的分类</font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; color: rgb(51, 51, 51);">       从对数据操作的类型（读</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">\</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">写）分</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><font><font style="font-family: 微软雅黑; font-size: 14pt;">读锁(共享锁)：针对同一份数据，多个读操作可以同时进行而不会互相影响。</font></font></div><div><font><font style="font-family: 微软雅黑; font-size: 14pt;">写锁（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</font></font></div></div><div style="font-size: 14pt;"><font>     表锁</font></div><div style="font-size: 14pt;"><font>     行锁</font></div><div style="font-size: 14pt;"><div><br/></div></div><div style="font-size: 14pt;"><div><br/></div></div><div style="font-size: 14pt;"><div><br/></div></div><div style="font-size: 14pt;"><div><br/></div></div><div style="font-size: 14pt;"><div><br/></div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="2747"/>

<div>
<span><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">特点</font></div><div>    <font style="font-size: 14pt;"> <span style="min-height: 17pt; color: rgb(51, 51, 51);">偏向</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">MyISAM</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">存储引擎，开销小，加锁快；无死锁；锁定粒度大，发生锁冲突的概率最高</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">并发度最低。</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);"><br/></span></font></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">案例分析</font></div><div>1、建表SQL<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="font-family: Arial; text-indent: 0mm; line-height: 1.45;">【表级锁分析--建表SQL】</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">create table mylock(</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;"> id int not null primary key auto_increment,</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;"> name varchar(20)</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">)</span><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">engine myisam;</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"><font style="font-size: 14pt;"> </font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into mylock(name) values('a');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into mylock(name) values('b');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into mylock(name) values('c');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into mylock(name) values('d');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into mylock(name) values('e');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">select * from mylock;</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande';">【</span><span style="text-indent: 0mm; min-height: 7pt; font-family: Arial;">手动增加表锁</span><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande';">】</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 8pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"> lock table 表名字1 read(write)，</span><span style="text-indent: 0mm; min-height: 8pt; font-family: Arial; color: rgb(51, 51, 51);">表名字2 read(write)，其它</span><span style="text-indent: 0mm; min-height: 8pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">;</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: Arial; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">【查看表上加过的锁】</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: Arial; color: rgb(51, 51, 51);">  show open tables;</span><span style="color: rgb(1, 1, 1); font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;"> </span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 289pt;"><font style="font-size: 14pt;"><img src="07_mysql_04_mysql锁机制_files/Image.png" type="image/png" data-filename="" style="font-family: Monaco; color: rgb(51, 51, 51);" width="537"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">【释放表锁】</font></span></div><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">unlock tables;</font></span></div></div><div><br/></div><div>2、加读锁<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 3pt;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: 'Lucida Grande'; color: rgb(0, 0, 255); font-size: 18pt;"> 我们为mylock表加read锁(读阻塞写例子)</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"></div></div><table style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;"><colgroup><col style="width: 597px;"></col><col style="width: 465px;"></col></colgroup><tbody><tr><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt; font-family: 'Lucida Grande'; font-size: 16pt;">session_1</span></div></td><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt; font-family: 'Lucida Grande'; font-size: 16pt;">session_2</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">获得表mylock的READ锁定</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 31pt;"><img src="07_mysql_04_mysql锁机制_files/Image [1].png" type="image/png" data-filename="" width="317"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">连接终端</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">当前session可以查询该表记录</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 116pt;"><img src="07_mysql_04_mysql锁机制_files/Image [2].png" type="image/png" data-filename="" width="241"/></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 6pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">其他session也可以查询该表的记录</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 147pt;"><span style="text-indent: 0mm; min-height: 147pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [3].png" type="image/png" data-filename="" width="242"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">当前session不能查询其它没有锁定的表</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 38pt;"><img src="07_mysql_04_mysql锁机制_files/Image [4].png" type="image/png" data-filename="" width="579"/></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">其他session可以查询或者更新未锁定的表</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 116pt;"><span style="text-indent: 0mm; min-height: 116pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [5].png" type="image/png" data-filename="" width="440"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">当前session中插入或者更新</span><span style="font-family: 'Lucida Grande'; color: rgb(255, 0, 0); font-size: 10pt;">锁定的表</span><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">都会提示错误：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 194pt;"><span style="text-indent: 0mm; min-height: 194pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [6].png" type="image/png" data-filename="" width="573"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">其他session插入或者更新锁定表</span><span style="font-family: 'Lucida Grande'; color: rgb(255, 0, 0); font-size: 10pt; font-weight: bold;">会一直等待</span><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">获得锁：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 44pt;"><span style="text-indent: 0mm; min-height: 44pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [7].png" type="image/png" data-filename="" width="395"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">释放锁</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 58pt;"><img src="07_mysql_04_mysql锁机制_files/Image [8].png" type="image/png" data-filename="" width="357"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session2获得锁，插入操作完成：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 52pt;"><img src="07_mysql_04_mysql锁机制_files/Image [9].png" type="image/png" data-filename="" width="361"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="586"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><br/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="454"><br/></td></tr></tbody></table><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div></div><div><br/></div><div>3、加写锁<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: 'Lucida Grande'; color: rgb(0, 0, 255); font-size: 18pt;"> mylock</span><span style="font-family: Arial; color: rgb(0, 0, 255); font-size: 18pt;">write(MyISAM)</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"></div></div><div style="margin-left: 6mm;"><table cellpadding="5" cellspacing="0" style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;" width="738"><colgroup><col style="width: 369px;"></col><col style="width: 369px;"></col></colgroup><tbody><tr><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt; font-family: 'Lucida Grande'; font-size: 16pt;">session_1</span></div></td><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt; font-family: 'Lucida Grande'; font-size: 16pt;">session_2</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">获得表mylock的WRITE锁定</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 53pt;"><img src="07_mysql_04_mysql锁机制_files/Image [10].png" type="image/png" data-filename="" width="297"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(255, 0, 0); font-size: 10pt;">待Session1开启写锁后</span><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">，session2再连接终端</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">当前session对锁定表的查询+更新+插入操作都可以执行：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 321pt;"><img src="07_mysql_04_mysql锁机制_files/Image [11].png" type="image/png" data-filename="" width="374"/></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">其他session对锁定表的查询被阻塞，需要等待锁被释放：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 2pt;"><span style="text-indent: 0mm; min-height: 2pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span> <img src="07_mysql_04_mysql锁机制_files/Image [12].png" type="image/png" data-filename="" width="357"/></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 3pt;"><span style="text-indent: 0mm; min-height: 3pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">在锁表前，如果session2有数据缓存，锁表以后，在锁住的表不发生改变的情况下session2可以读出缓存数据，一旦数据发生改变，缓存将失效，操作将被阻塞住。</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">释放锁</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 58pt;"><img src="07_mysql_04_mysql锁机制_files/Image [13].png" type="image/png" data-filename="" width="357"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session2获得锁，查询返回：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 131pt;"><span style="text-indent: 0mm; min-height: 131pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [14].png" type="image/png" data-filename="" width="343"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="358"><div><br/></div></td></tr></tbody></table></div></div><div><br/></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">结论</font><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">MyISAM在执行查询语句（SELECT）前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">MySQL的表级锁有两种模式：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"> 表共享读锁（Table Read Lock）</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"> 表独占写锁（Table Write Lock）</font></span></div><table style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;"><colgroup><col style="width: 61px;"></col><col style="width: 61px;"></col><col style="width: 61px;"></col><col style="width: 61px;"></col><col style="width: 61px;"></col><col style="width: 61px;"></col></colgroup><tbody><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">锁类型</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">自己可读</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">自己可写</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">自己可操作其他表</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">他人可读</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">他人可写</font></span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">读锁</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">是</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;">否</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">否</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">是</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">否，等</font></span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">写锁</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">是</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;">是</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 19pt;"><span style="text-indent: 0mm; min-height: 19pt;"><font face="微软雅黑" style="font-size: 14pt;">否</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">否，等</font></span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="50"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt;"><font face="微软雅黑" style="font-size: 14pt;">否，等</font></span></div></td></tr></tbody></table><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">结论：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"> 结合上表，所以对MyISAM表进行操作，会有以下情况：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">  1、对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">  2、对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</font></span></div><div><span style="text-indent: 0mm; color: rgb(255, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;"> 简而言之，就是读锁会阻塞写，但是不会堵塞读。而写锁则会把读和写都堵塞</font></span></div></div><div><br/></div><div><br/></div></span>
</div>
<hr>
<a name="2749"/>

<div>
<span><div><span><font style="font-size: 18pt; color: rgb(186, 0, 255);">特点</font></span></div><div><span><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">       偏向</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">InnoDB</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">,</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">并发度也最高。</span></font></span></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">       InnoDB</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">与</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">MyISAM</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">的最大不同有两点：一是支持事务（</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">TRANSACTION</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">）；二是采用了行级锁</span></font></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">复习</font></div><div>      事务（transaction）及其ACID属性</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;"><font style="font-size: 14pt;">事务是由一组SQL语句组成的逻辑处理单元，事务具有以下4个属性，通常简称为事务的ACID属性。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">l</span> <span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">原子性（Atomicity）</span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">l</span> <span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">一致性（Consistent）</span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">：在事务开始和完成时，数据都必须保持一致状态。这意味着所有相关的数据规则都必须应用于事务的修改，以保持数据的完整性；事务结束时，所有的内部数据结构（如B树索引或双向链表）也都必须是正确的。</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">l</span> <span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">隔离性（Isolation）</span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">：数据库系统提供一定的隔离机制，保证事务在不受外部并发操作影响的“独立”环境执行。这意味着事务处理过程中的中间状态对外部是不可见的，反之亦然。</span></font></div><div><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">l</span> <span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">持久性（Durable）</span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">：事务完成之后，它对于数据的修改是永久性的，即使出现系统故障也能够保持。</span></font></div></div><div>       并发事务处理带来的问题</div><div>1、脏读（dirty reads）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">        </span><span style="text-indent: 0mm; line-height: 1.45;"><font face="微软雅黑" style="font-size: 14pt;">一个事务正在对一条记录做修改，在这个事务完成并提交前，这条记录的数据就处于不一致状态；这时，另一个事务也来读取同一条记录，如果不加控制，第二个事务读取了这些“脏”数据，并据此做进一步的处理，就会产生未提交的数据依赖关系。这种现象被形象地叫做”脏读”。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 2pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 2pt; color: rgb(51, 51, 51);">      一句话：事务A读取到了事务B</span><span style="text-indent: 0mm; min-height: 2pt; color: rgb(255, 0, 0);">已修改但尚未提交</span><span style="text-indent: 0mm; min-height: 2pt; color: rgb(51, 51, 51);">的的数据，还在这个数据基础上做了操作。此时，如果B事务回滚，A读取</span><span style="text-indent: 0mm; line-height: 1.45;">的数据无效，不符合一致性要求。</span></font></div></div><div>2、不可重复读（Non-Repeatable Reads）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; font-size: 16pt; color: rgb(51, 51, 51);">    </span><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">   在一个事务内，多次读同一个数据。在这个事务还没有结束时，另一个事务也访问该同一数据。那么，在第一个事务的两次读数据之间。由于第二个事务的修改，那么第一个事务读到的数据可能不一样，这样就发生了在一个事务内两次读到的数据是不一样的，因此称为不可重复读，即原始读取不可重复。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">      一句话：一个事务范围内两个相同的查询却返回了不同数据。</font></span></div></div><div><br/></div><div>3、幻读（Phantom Reads）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span> <font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);">一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为“幻读”。</span><span style="color: rgb(1, 1, 1); text-indent: 0mm; line-height: 1.45;"> </span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);">一句话：事务A</span> <span style="text-indent: 0mm; color: rgb(51, 51, 51);">读取到了事务B提交的新增数据，不符合隔离性。</span></font></div></div><div><br/></div><div>      事务隔离级别</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">脏读”、“不可重复读”和“幻读”，其实都是数据库读一致性问题，必须由数据库提供一定的事务隔离机制来解决。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 149pt;"><font style="font-size: 14pt;"><img src="07_mysql_04_mysql锁机制_files/Image [15].png" type="image/png" data-filename="" style="font-family: Monaco; color: rgb(51, 51, 51);" width="1015"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 1pt;"><span style="text-indent: 0mm; min-height: 1pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">      数据库的事务隔离越严格，并发副作用越小，但付出的代价也就越大，因为事务隔离实质上就是使事务在一定程度上 “串行化”进行，这显然与“并发”是矛盾的。同时，不同的应用对读一致性和事务隔离程度的要求也是不同的，比如许多应用对“不可重复读”和“幻读”并不敏感，可能更关心数据并发访问的能力。</font></span></div><div><span style="text-indent: 0mm; min-height: 2pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">常看当前数据库的事务隔离级别：show variables like 'tx_isolation';</font></span></div></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">案例分析</font></div><div>1、建表SQL<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);">create table test_innodb_lock (a int(11),b varchar(16))</span><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(255, 0, 0);">engine=innodb;</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(1,'b2');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(3,'3');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(4,'4000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(5,'5000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(6,'6000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(7,'7000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(8,'8000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(9,'9000');</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 2pt;"><span style="text-indent: 0mm; min-height: 2pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">insert into test_innodb_lock values(1,'b1');</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"><font style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">create index test_innodb_a_ind on test_innodb_lock(a);</span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"><font style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">create index test_innodb_lock_b_ind on test_innodb_lock(b);</span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"><font style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">select * from test_innodb_lock;</span></div></div><div><span style="line-height: 1.45;">2、行锁定基本演示</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="color: rgb(1, 1, 1); font-family: 'Lucida Grande'; font-size: 10pt; text-indent: 0mm; line-height: 1.45;">行锁定基本演示</span></div><table style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;"><colgroup><col style="width: 496px;"></col><col style="width: 538px;"></col></colgroup><tbody><tr><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_1</span></div></td><td align="center" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_2</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 61pt;"><img src="07_mysql_04_mysql锁机制_files/Image [16].png" type="image/png" data-filename="" width="306"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 61pt;"><img src="07_mysql_04_mysql锁机制_files/Image [17].png" type="image/png" data-filename="" width="306"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">更新但是不提交，没有手写commit;</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 80pt;"><span style="text-indent: 0mm; min-height: 80pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><img src="07_mysql_04_mysql锁机制_files/Image [18].png" type="image/png" data-filename="" width="471"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_2被阻塞，只能等待</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 53pt;"><img src="07_mysql_04_mysql锁机制_files/Image [19].png" type="image/png" data-filename="" width="617"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">提交更新</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 28pt;"><img src="07_mysql_04_mysql锁机制_files/Image [20].png" type="image/png" data-filename="" width="317"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">解除阻塞，更新正常进行</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 33pt;"><img src="07_mysql_04_mysql锁机制_files/Image [21].png" type="image/png" data-filename="" width="475"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">commit命令执行</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="485"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">下面试试1号会话更新a =1</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="527"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 11pt;"><span style="text-indent: 0mm; min-height: 11pt; font-family: Arial; font-size: 10pt;">下面试试2号会话更新a =9</span></div></td></tr></tbody></table><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span></div></div><div><br/></div><div>3、select也可以加锁</div><div>     读锁<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 3pt; font-size: 14pt; color: rgb(51, 51, 51);"><font face="微软雅黑">共享锁(Share Lock)</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);">      </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">共享锁又称读锁，是读取操作创建的锁。其他用户可以并发读取数据，但任何事务都不能对数据进行修改（获取数据上的排他锁），直到已释放所有共享锁。</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-size: 14pt; color: rgb(51, 51, 51);"><font face="微软雅黑">      如果事务T对数据A加上共享锁后，则其他事务只能对A再加共享锁，不能加排他锁。获准共享锁的事务只能读数据，不能修改数据。</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);"> </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">用法</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><span style="text-indent: 0mm; min-height: 0pt; font-size: 14pt; color: rgb(51, 51, 51);"><font face="微软雅黑">SELECT ... LOCK IN SHARE MODE;</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);">      </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">在查询语句后面增加 LOCK IN SHARE MODE ，Mysql会对查询结果中的每行都加共享锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请共享锁，否则会被阻塞。其他线程也可以读取使用了共享锁的表，而且这些线程读取的是同一个版本的数据</span></font></div></div><div>     写锁<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 3pt; font-size: 14pt; color: rgb(51, 51, 51);"><font face="微软雅黑">排他锁（eXclusive Lock）</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);">      </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">共享锁又称写锁，如果事务T对数据A加上排他锁后，则其他事务不能再对A加任任何类型的封锁。获准排他锁的事务既能读数据，又能修改数据。</span></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);"> </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">用法</span></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);"> </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">SELECT ... FOR UPDATE;</span></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑"><span style="text-indent: 0mm; min-height: 9pt; font-size: 14pt; color: rgb(51, 51, 51);"> </span><span style="font-size: 14pt; text-indent: 0mm; line-height: 1.45;">       在查询语句后面增加 FOR UPDATE ，Mysql会对查询结果中的每行都加排他锁，当没有其他线程对查询结果集中的任何一行使用排他锁时，可以成功申请排他锁，否则会被阻塞。</span></font></div></div><div><br/></div><div>4、无索引行锁升级为表锁</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><table style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;"><colgroup><col style="width: 505px;"></col><col style="width: 461px;"></col></colgroup><tbody><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_1</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_2</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">正常情况，各自锁定各自的行，互相不影响，一个2000另一个3000</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 37pt;"><img src="07_mysql_04_mysql锁机制_files/Image [22].png" type="image/png" data-filename="" width="493"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 48pt;"><img src="07_mysql_04_mysql锁机制_files/Image [23].png" type="image/png" data-filename="" width="449"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">由于在column字段b上面建了索引，如果没有正常使用，会导致行锁变表锁</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">比如没加单引号导致索引失效，行锁变表锁</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 40pt;"><img src="07_mysql_04_mysql锁机制_files/Image [24].png" type="image/png" data-filename="" width="475"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">被阻塞，等待。只到Session_1提交后才阻塞解除，完成更新</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 48pt;"><img src="07_mysql_04_mysql锁机制_files/Image [25].png" type="image/png" data-filename="" width="437"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="494"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="450"><br/></td></tr></tbody></table></div></div><div><br/></div><div>5、间隙锁危害</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">间隙锁带来的插入问题</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"></div></div><table style="table-layout: fixed; border-collapse: collapse; border-width: 1px; border-color: #000000;"><colgroup><col style="width: 477px;"></col><col style="width: 561px;"></col></colgroup><tbody><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="466"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_1</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="550"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">Session_2</span></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="466"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 42pt;"><img src="07_mysql_04_mysql锁机制_files/Image [26].png" type="image/png" data-filename="" width="466"/></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="550"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">阻塞产生，暂时不能插入</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 43pt;"><img src="07_mysql_04_mysql锁机制_files/Image [27].png" type="image/png" data-filename="" width="602"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="466"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">commit;</span></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="550"><div><span style="font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">阻塞解除，完成插入</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 47pt;"><img src="07_mysql_04_mysql锁机制_files/Image [28].png" type="image/png" data-filename="" width="598"/></div></td></tr><tr><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="466"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td><td align="left" style="border: 1px solid rgb(0, 0, 0);" valign="top" width="550"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.99mm; margin-bottom: 1.99mm; min-height: 12pt;"></div></td></tr></tbody></table><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><font style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande';">【</span><span style="text-indent: 0mm; min-height: 7pt; font-family: Arial;">什么是间隙锁</span><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande';">】</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">      当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP)”，</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">InnoDB也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁（GAP Lock）。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;">【危害】</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">      因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。</font></span></div><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">      间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</font></span></div></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">案例结论</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 2pt;"><span style="text-indent: 0mm; min-height: 2pt; font-family: 'Lucida Grande'; font-size: 16pt; color: rgb(51, 51, 51);">   </span> <span style="text-indent: 0mm; min-height: 2pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">   Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势了。</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"> </span><span style="text-indent: 0mm; line-height: 1.45;">      但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差</span></font></div></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">行锁分析</font><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 微软雅黑; font-size: 14pt; line-height: 1.45; text-indent: 0mm;">【如何分析行锁定】</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">mysql&gt;show status like 'innodb_row_lock%';</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 114pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="07_mysql_04_mysql锁机制_files/Image [29].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="359"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">对各个状态量的说明如下：</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">Innodb_row_lock_current_waits：当前正在等待锁定的数量；</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">Innodb_row_lock_time_avg：每次等待所花平均时间；</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(51, 51, 51);">对于这5个状态变量，</span><span style="text-indent: 0mm; min-height: 8pt; color: rgb(255, 0, 0);">比较重要的主要是</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(255, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;">  Innodb_row_lock_time_avg（等待平均时长），</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(255, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;">  Innodb_row_lock_waits（等待总次数）</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 8pt;"><span style="text-indent: 0mm; min-height: 8pt; color: rgb(255, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;">  Innodb_row_lock_time（等待总时长）这三项。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。</font></span></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">最后可以通过</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">SELECT * FROM information_schema.INNODB_TRX\G;</font></span></div><div><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">来查询正在被锁阻塞的sql语句。</font></span></div></div><div><br/></div><div><br/></div><div><font style="font-size: 18pt; color: rgb(186, 0, 255);">优化建议</font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">1</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、不要三心二意，锁住哪行，就改哪行</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">2</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、要说话算数，说读锁就干读的事，说写锁就干写的事</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">3</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、不要拖拖拉拉，用了锁，就赶紧办事，办完事赶紧提交</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">4</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、如果锁，请轻锁，一锁一大片，中间再也无法容纳他人了。（间隙锁的问题）</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">5</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、无索引，不行锁。（行锁的前提是过滤条件利用上了索引）。</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 17pt; color: rgb(51, 51, 51);">6</span><span style="min-height: 17pt; color: rgb(51, 51, 51);">、用情越深，付出越大。（隔离级别越高，锁成本越高）。</span></font></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 