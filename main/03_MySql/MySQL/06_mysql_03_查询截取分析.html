<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/305825 (zh-CN, DDL); Windows/10.0.10240 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 14pt;
    }
  </style>
</head>
<body>
<a name="2715"/>

<div>
<span><div>慢查询日志是什么</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="color: rgb(0, 0, 0);"><font style="font-family: 微软雅黑; font-size: 14pt;">MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</font></span></li></ul><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="color: rgb(0, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;">具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。</font></span></li></ul><div><span style="text-indent: 0mm; color: rgb(1, 1, 1); font-size: 10pt;"><font face="微软雅黑"> </font></span></div></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-family: 微软雅黑; font-size: 14pt;"><span style="color: rgb(0, 0, 0);">由他来查看哪些</span>SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</font></li></ul></div><div><br/></div><div>慢查询日志怎么玩</div><div>1、说明</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="color: rgb(0, 0, 0);"><font face="微软雅黑" style="font-size: 14pt;">MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</font></span></li></ul><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"><span style="color: rgb(0, 0, 0);">具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。</span></font></li></ul></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"><span style="color: rgb(0, 0, 0);">由他来查看哪些</span>SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</font></li></ul></div><div><span style="line-height: 1.45;">2、查看是否开启及如何开启</span><br/></div><div>      默认</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;">       </span><span style="line-height: 1.45; text-indent: 0mm;"><font face="微软雅黑" style="font-size: 14pt;">默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的，</font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">可以通过设置slow_query_log的值来开启</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 12pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 12pt; color: rgb(51, 51, 51);">SHOW VARIABLES LIKE '%slow_query_log%';</span><span style="color: rgb(1, 1, 1); text-indent: 0mm; line-height: 1.45;"> </span></font></div><div><img src="06_mysql_03_查询截取分析_files/Image.png" type="image/png" data-filename="" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);" width="599"/></div></div><div>     开启<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">使用set global slow_query_log=1开启了慢查询日志</span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45; color: rgb(255, 0, 0);">只对当前数据库生效，</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">如果MySQL重启后则会失效。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 83pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [1].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="421"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 78pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [2].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="376"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; color: rgb(1, 1, 1); text-indent: 0mm; line-height: 1.45;">全局变量设置，对当前连接不影响</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 22pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [3].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="288"/></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; color: rgb(1, 1, 1); text-indent: 0mm; line-height: 1.45;">对当前连接立刻生效</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 108pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [4].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="354"/></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="text-indent: 0mm; font-size: 14pt; font-family: 微软雅黑; line-height: 1.45;">如果要永久生效，就必须修改配置文件</span><span style="text-indent: 0mm; font-size: 14pt; font-family: 微软雅黑; line-height: 1.45;">my.cnf</span><span style="text-indent: 0mm; font-size: 14pt; font-family: 微软雅黑; line-height: 1.45;">（其它系统变量也是如此）</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">修改my.cnf文件，[mysqld]下增加或修改参数</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">slow_query_log 和slow_query_log_file后，然后重启MySQL服务器。也即将如下两行配置进my.cnf文件</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">slow_query_log =1</span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 5pt;"><span style="text-indent: 0mm; min-height: 5pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">slow_query_log_file=/var/lib/mysql/atguigu-slow.log</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"> </font></span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">关于慢查询的参数slow_query_log_file ，它指定慢查询日志文件的存放路径，</span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45; color: rgb(255, 0, 0);">系统默认会给一个缺省的文件host_name-slow.log</span><span style="font-size: 14pt; font-family: 微软雅黑; text-indent: 0mm; line-height: 1.45;">（如果没有指定参数slow_query_log_file的话）</span></div></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; color: rgb(51, 51, 51);">那么开启了慢查询日志后，什么样的</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">SQL</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">才会记录到慢查询日志里面呢？</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="line-height: 1.45; text-indent: 0mm;"><font face="微软雅黑" style="font-size: 14pt;">这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">命令：SHOW VARIABLES LIKE 'long_query_time%';</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 123pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [5].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="541"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 6pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 6pt; color: rgb(51, 51, 51);">可以使用命令修改，也可以在my.cnf参数里</span><span style="text-indent: 0mm; min-height: 6pt; color: rgb(51, 51, 51);">面修改。</span></font></div><div style="margin: 0.99mm 0mm 1.99mm; text-indent: 0mm; min-height: 9pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(1, 1, 1);"> </span><span style="text-indent: 0mm; line-height: 1.45;">假如运行时间正好等于long_query_time的情况，并不会被记录下来。也就是说，</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);">在mysql源码里是</span><span style="text-indent: 0mm; color: rgb(255, 0, 0);">判断大于long_query_time，而非大</span><span style="text-indent: 0mm; color: rgb(255, 0, 0);">于等于</span><span style="text-indent: 0mm; color: rgb(51, 51, 51);">。</span></font></div></div><div><span style="line-height: 1.45;">3、case</span><br/></div><div><span style="line-height: 1.45;">     1)、查看当前多少秒算慢（<span style="min-height: 10pt; font-family: Tahoma; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">SHOW VARIABLES LIKE 'long_query_time%';</font></span>）</span></div><div><span style="line-height: 1.45;">     2)、设置慢的阀值时间</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="line-height: 1.45; text-indent: 0mm;"><font face="微软雅黑" style="font-size: 14pt;">使用命令</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">set global long_query_time=1</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">修改为阙值到1秒钟的就是慢sql</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 204pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [6].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="380"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><span style="text-indent: 0mm; min-height: 0pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;">修改后发现long_query_time并没有改变。</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 13pt;">需要重新连接或新开一个会话才能看到修改值。</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 13pt;">SHOW VARIABLES LIKE 'long_query_time%';</span><br/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><span style="text-indent: 0mm; min-height: 0pt; color: rgb(1, 1, 1);"><font><span style="min-height: 13pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;"><span style="min-height: 13pt; color: rgb(51, 51, 51);">或者通过</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">set session long_query_time=1</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">来改变当前</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">session</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">变量</span><span style="min-height: 13pt; color: rgb(51, 51, 51);">;</span></font><br/></span></font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 0pt;"><span style="text-indent: 0mm; min-height: 0pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51); font-size: 9pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51); font-size: 9pt;"><img src="06_mysql_03_查询截取分析_files/Image [7].png" type="image/png" data-filename="" style="font-family: Tahoma; font-size: 9pt; color: rgb(51, 51, 51);"/><br/></span></span></font></span></div></div><div><span style="line-height: 1.45;">     3)、记录慢SQL并后续分析</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 0pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="text-indent: 0mm; min-height: 0pt; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;">实验一条慢sql</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 99pt;"><font face="微软雅黑" style="font-size: 14pt;"><img src="06_mysql_03_查询截取分析_files/Image [8].png" type="image/png" data-filename="" style="color: rgb(51, 51, 51);" width="206"/></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(1, 1, 1);"><font face="微软雅黑" style="font-size: 14pt;">跟踪日志信息</font></span></div><div><img src="06_mysql_03_查询截取分析_files/Image [9].png" type="image/png" data-filename="" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);" width="649"/></div></div><div><span style="line-height: 1.45;">     4)、查询当前系统中有多少条慢查询记录</span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; font-size: 18pt; line-height: 1.45; text-indent: 0mm;">show global status like '%Slow_queries%';</span></div><div><img src="06_mysql_03_查询截取分析_files/Image [10].png" type="image/png" data-filename="" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);" width="380"/></div></div><div><br/></div><div>4、配置版<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; line-height: 1.45;"><font face="微软雅黑" style="font-size: 14pt;"> my.cnf</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">【mysqld】下配置：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><font face="微软雅黑" style="font-size: 14pt;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"> </span><span style="text-indent: 0mm; line-height: 1.45;">slow_query_log=1;</span></font></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">slow_query_log_file=/var/lib/mysql/atguigu-slow.log</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">long_query_time=3;</font></span></div><div><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">log_output=FIL</font></span></div></div><div><br/></div><div>日志分析工具mysqldumpslow</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 3pt; color: rgb(51, 51, 51);"><font style="font-family: 微软雅黑; font-size: 14pt;">在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow</font></span></div></div><div>1、查看mysqldumpslow的帮助信息<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 12pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; font-size: 18pt; text-indent: 0mm; line-height: 1.45;">mysqldumpslow --help</span></div><div><img src="06_mysql_03_查询截取分析_files/Image [11].png" type="image/png" data-filename="" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);" width="730"/></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(255, 0, 0);">-s:</span> <span style="min-height: 13pt; font-family: 宋体; color: rgb(255, 0, 0);">是表示按照何种方式排序；</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">c:</span> <span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">访问次数</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">l:</span> <span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">锁定时间</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">r:</span> <span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">返回记录</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">t:</span> <span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">查询时间</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">al:</span><span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">平均锁定时间</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">ar:</span><span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">平均返回记录数</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(51, 51, 51);">at:</span><span style="min-height: 13pt; font-family: 宋体; color: rgb(51, 51, 51);">平均查询时间</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(255, 0, 0);">-t:</span><span style="min-height: 13pt; font-family: 宋体; color: rgb(255, 0, 0);">即为返回前面多少条的数据；</span></font></div><div><font style="font-size: 14pt;"><span style="min-height: 13pt; font-family: Tahoma; color: rgb(255, 0, 0);">-g:</span><span style="min-height: 13pt; font-family: 宋体; color: rgb(255, 0, 0);">后边搭配一个正则匹配模式，大小写不敏感的；</span></font></div></div><div><br/></div><div><br/></div><div><br/></div><div>2、工作常用参考<br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 9pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">得到返回记录集最多的10个SQL</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 17pt;"><span style="text-indent: 0mm; min-height: 17pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">得到访问次数最多的10个SQL</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">mysqldumpslow -s c -t 10 /var/lib/mysql/atguigu-slow.log</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 3pt;"><span style="text-indent: 0mm; min-height: 3pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">得到按照时间排序的前10条里面含有左连接的查询语句</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/atguigu-slow.log</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 3pt;"><span style="text-indent: 0mm; min-height: 3pt; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况</font></span></div><div><span style="text-indent: 0mm; color: rgb(51, 51, 51);"><font face="微软雅黑" style="font-size: 14pt;">mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log | more</font></span></div></div><div><br/></div></span>
</div>
<hr>
<a name="2717"/>

<div>
<span><div>配置启用</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; line-height: 1.45; text-indent: 0mm;"><font style="font-size: 14pt;">在mysql的my.cnf中，设置如下：</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">#开启</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">general_log=1  </font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;"># 记录日志文件的路径</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 7pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">general_log_file=/path/logfile</font></span></div><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 9pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">#输出格式</font></span></div><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">log_output=FILE</font></span></div></div><div>编码启用</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(1, 1, 1); font-size: 10pt;"> </span><span style="font-family: 'Lucida Grande'; text-indent: 0mm; line-height: 1.45;"><font style="font-size: 14pt;">命令</font></span></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="font-family: 'Lucida Grande'; color: rgb(0, 0, 0);"><font style="font-size: 14pt;">set global general_log=1;</font></span></li></ul><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm;"><span style="text-indent: 0mm; font-family: 'Lucida Grande'; color: rgb(51, 51, 51);"><font style="font-size: 14pt;">#全局日志可以存放到日志文件中，也可以存放到Mysql系统表中。存放到日志中性能更好一些，存储到表中</font></span></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="font-family: 'Lucida Grande'; color: rgb(0, 0, 0);"><font style="font-size: 14pt;">set global log_output='TABLE';</font></span></li></ul><div style="margin-left: 0mm; margin-right: 0mm; text-indent: 0mm; margin-top: 4.75mm; margin-bottom: 4.75mm; min-height: 6pt;"><font style="font-size: 14pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: 'Lucida Grande'; color: rgb(1, 1, 1);"> </span><span style="font-family: 'Lucida Grande'; line-height: 1.45; text-indent: 0mm;">此后 ，你所编写的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看</span></font></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 26pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><span style="font-family: 'Lucida Grande'; color: rgb(0, 0, 0);"><font style="font-size: 14pt;">select * from mysql.general_log;</font></span></li></ul></div><div><font style="color: rgb(235, 0, 115);">尽量不要在生产环境开启这个功能</font></div></span>
</div>
<hr>
<a name="2719"/>

<div>
<span><div>能干什么：查询所有用户正在干什么</div><div><br/></div><div>如果出现不顺眼的</div><div><br/></div><div>kill [id]</div></span>
</div></body></html> 